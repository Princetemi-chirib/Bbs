// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  BARBER
  ADMIN
  REP
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIALLY_PAID
  REFUNDED
  FAILED
}

enum BarberStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_APPROVAL
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  FLAGGED
  BLOCKED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  avatarUrl     String?   @map("avatar_url")
  role          UserRole
  emailVerified Boolean   @default(false) @map("email_verified")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  barber        Barber?
  customer      Customer?
  notifications Notification[]
  barberApplication BarberApplication?

  @@map("users")
  @@index([email])
  @@index([role])
}

model Barber {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  barberId         String   @unique @map("barber_id")
  bio              String?  @db.Text
  experienceYears  Int?     @map("experience_years")
  specialties      String[]
  certifications   Json?
  ratingAvg        Decimal  @default(0) @db.Decimal(3, 2) @map("rating_avg")
  totalReviews     Int      @default(0) @map("total_reviews")
  totalBookings    Int      @default(0) @map("total_bookings")
  status           BarberStatus @default(PENDING_APPROVAL)
  commissionRate   Decimal  @default(0.70) @db.Decimal(3, 2) @map("commission_rate")
  location         String?
  languagesSpoken  String[] @map("languages_spoken")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  services         Service[]
  bookings         Booking[]
  timeSlots        TimeSlot[]
  availability     BarberAvailability[]
  reviews          Review[]
  preferredBy      Customer[]
  assignedOrders   Order[]  @relation("AssignedOrders")

  @@map("barbers")
  @@index([status])
  @@index([ratingAvg])
}

model Customer {
  id               String         @id @default(uuid())
  userId           String         @unique @map("user_id")
  customerId       String         @unique @map("customer_id")
  preferredBarberId String?       @map("preferred_barber_id")
  loyaltyPoints    Int            @default(0) @map("loyalty_points")
  membershipType   String         @default("BASIC") @map("membership_type")
  status           CustomerStatus @default(ACTIVE)
  dateOfBirth      DateTime?      @map("date_of_birth")
  gender           String?
  address          String?        @db.Text
  preferredBranch  String?        @map("preferred_branch")
  allergies        String?        @db.Text
  servicePreferences String[]     @map("service_preferences")
  emailConsent     Boolean        @default(true) @map("email_consent")
  smsConsent       Boolean        @default(true) @map("sms_consent")
  dataConsent      Boolean        @default(true) @map("data_consent")
  consentDate      DateTime?      @map("consent_date")
  referralCode     String?        @unique @map("referral_code")
  referredBy       String?       @map("referred_by") // Customer ID
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  preferredBarber  Barber?        @relation(fields: [preferredBarberId], references: [id])
  bookings         Booking[]
  reviews          Review[]
  payments         Payment[]
  tickets          SupportTicket[]
  notes            CustomerNote[]
  tags             CustomerTag[]
  auditLogs        CustomerAuditLog[]
  communications   CustomerCommunication[]
  preferences      CustomerPreference?

  @@map("customers")
  @@index([preferredBarberId])
  @@index([status])
  @@index([membershipType])
  @@index([referralCode])
}

model Service {
  id              String   @id @default(uuid())
  barberId        String   @map("barber_id")
  name            String
  description     String?  @db.Text
  price           Decimal  @db.Decimal(10, 2)
  durationMinutes Int      @map("duration_minutes")
  category        String
  isActive        Boolean  @default(true) @map("is_active")
  imageUrl        String?  @map("image_url")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  barber          Barber   @relation(fields: [barberId], references: [id], onDelete: Cascade)
  bookings        Booking[]

  @@map("services")
  @@index([barberId])
  @@index([category])
}

model Booking {
  id                String        @id @default(uuid())
  bookingNumber     String        @unique @map("booking_number")
  customerId        String        @map("customer_id")
  barberId          String        @map("barber_id")
  serviceId         String        @map("service_id")
  bookingDate       DateTime      @db.Date @map("booking_date")
  bookingTime       DateTime      @db.Time(6) @map("booking_time")
  durationMinutes   Int           @map("duration_minutes")
  status            BookingStatus @default(PENDING)
  totalPrice        Decimal       @db.Decimal(10, 2) @map("total_price")
  paymentStatus     PaymentStatus @default(PENDING) @map("payment_status")
  paymentMethod     String?       @map("payment_method")
  notes             String?       @db.Text
  barberNotes       String?       @db.Text @map("barber_notes")
  cancellationReason String?      @db.Text @map("cancellation_reason")
  cancelledBy       String?       @map("cancelled_by")
  cancelledAt       DateTime?     @map("cancelled_at")
  completedAt       DateTime?     @map("completed_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  customer          Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  barber            Barber        @relation(fields: [barberId], references: [id])
  service           Service       @relation(fields: [serviceId], references: [id])
  payment           Payment?
  review            Review?
  timeSlot          TimeSlot?

  @@map("bookings")
  @@index([customerId])
  @@index([barberId])
  @@index([bookingDate])
  @@index([status])
  @@index([barberId, bookingDate, bookingTime])
}

model TimeSlot {
  id          String    @id @default(uuid())
  barberId    String    @map("barber_id")
  date        DateTime  @db.Date
  startTime   DateTime  @db.Time(6) @map("start_time")
  endTime     DateTime  @db.Time(6) @map("end_time")
  isAvailable Boolean   @default(true) @map("is_available")
  bookingId   String?   @unique @map("booking_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  barber      Barber    @relation(fields: [barberId], references: [id], onDelete: Cascade)
  booking     Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@map("time_slots")
  @@index([barberId])
  @@index([date])
  @@index([barberId, date, startTime])
}

model BarberAvailability {
  id         String    @id @default(uuid())
  barberId   String    @map("barber_id")
  dayOfWeek  Int       @map("day_of_week") // 0 = Sunday, 6 = Saturday
  startTime  DateTime  @db.Time(6) @map("start_time")
  endTime    DateTime  @db.Time(6) @map("end_time")
  isAvailable Boolean  @default(true) @map("is_available")
  breakStart DateTime? @db.Time(6) @map("break_start")
  breakEnd   DateTime? @db.Time(6) @map("break_end")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  barber     Barber    @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@map("barber_availability")
  @@index([barberId])
  @@index([barberId, dayOfWeek])
}

model Review {
  id              String    @id @default(uuid())
  bookingId       String    @unique @map("booking_id")
  customerId      String    @map("customer_id")
  barberId        String    @map("barber_id")
  rating          Int       // 1-5
  comment         String?   @db.Text
  barberResponse  String?   @db.Text @map("barber_response")
  barberResponseAt DateTime? @map("barber_response_at")
  isVerified      Boolean   @default(true) @map("is_verified")
  isVisible       Boolean   @default(true) @map("is_visible")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer        Customer  @relation(fields: [customerId], references: [id])
  barber          Barber    @relation(fields: [barberId], references: [id])

  @@map("reviews")
  @@index([customerId])
  @@index([barberId])
  @@index([rating])
  @@index([isVisible])
}

model Payment {
  id              String        @id @default(uuid())
  bookingId       String        @unique @map("booking_id")
  customerId      String        @map("customer_id")
  amount          Decimal       @db.Decimal(10, 2)
  paymentMethod   String        @map("payment_method")
  paymentGateway  String?       @map("payment_gateway")
  transactionId   String?       @unique @map("transaction_id")
  gatewayResponse Json?         @map("gateway_response")
  status          PaymentStatus @default(PENDING)
  refundAmount    Decimal       @default(0) @db.Decimal(10, 2) @map("refund_amount")
  refundReason    String?       @db.Text @map("refund_reason")
  processedAt     DateTime?     @map("processed_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  booking         Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer        Customer      @relation(fields: [customerId], references: [id])

  @@map("payments")
  @@index([bookingId])
  @@index([customerId])
  @@index([transactionId])
  @@index([status])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String   @db.Text
  actionUrl String?  @map("action_url")
  isRead    Boolean  @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
  @@index([userId])
  @@index([isRead])
  @@index([userId, isRead])
}

model SupportTicket {
  id          String   @id @default(uuid())
  ticketNumber String  @unique @map("ticket_number")
  customerId  String   @map("customer_id")
  assignedTo  String?  @map("assigned_to") // User ID (rep/admin)
  subject     String
  description String   @db.Text
  category    String   // BOOKING_ISSUE, PAYMENT_ISSUE, TECHNICAL, GENERAL
  priority    String   // LOW, MEDIUM, HIGH, URGENT
  status      String   @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  resolution  String?  @db.Text
  resolvedAt  DateTime? @map("resolved_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("support_tickets")
  @@index([customerId])
  @@index([assignedTo])
  @@index([status])
  @@index([priority])
}

model BarberApplication {
  id              String    @id @default(uuid())
  userId          String?   @unique @map("user_id") // If user account created
  email           String
  name            String
  phone           String
  experienceYears Int?      @map("experience_years")
  specialties     String[]
  certifications  Json?
  portfolioUrl    String?   @map("portfolio_url")
  resumeUrl       String?   @map("resume_url")
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED, UNDER_REVIEW
  adminNotes      String?   @db.Text @map("admin_notes")
  reviewedBy      String?   @map("reviewed_by") // Admin user ID
  reviewedAt      DateTime? @map("reviewed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("barber_applications")
  @@index([email])
  @@index([status])
}

enum ProductCategory {
  GENERAL
  RECOVERY
}

model Product {
  id              String          @id @default(uuid())
  title           String
  description     String?         @db.Text
  adultPrice      Decimal         @db.Decimal(10, 2) @map("adult_price")
  kidsPrice       Decimal?        @db.Decimal(10, 2) @map("kids_price") // null means same as adult
  category        ProductCategory
  beforeImage     String          @map("before_image")
  afterImage      String          @map("after_image")
  isActive        Boolean         @default(true) @map("is_active")
  displayOrder    Int             @default(0) @map("display_order")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  orderItems      OrderItem[]

  @@map("products")
  @@index([category])
  @@index([isActive])
  @@index([displayOrder])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  COMPLETED
  CANCELLED
}

enum JobStatus {
  PENDING_ACCEPTANCE
  ACCEPTED
  ON_THE_WAY
  ARRIVED
  COMPLETED
  DECLINED
}

model Order {
  id                String        @id @default(uuid())
  orderNumber       String        @unique @map("order_number")
  customerName      String        @map("customer_name")
  customerEmail     String        @map("customer_email")
  customerPhone     String        @map("customer_phone")
  city              String
  location          String
  address           String?       @db.Text
  additionalNotes   String?       @db.Text @map("additional_notes")
  totalAmount       Decimal       @db.Decimal(10, 2) @map("total_amount")
  paymentReference  String?       @unique @map("payment_reference")
  paymentMethod     String?       @map("payment_method")
  paymentStatus     PaymentStatus @default(PENDING) @map("payment_status")
  status            OrderStatus   @default(PENDING)
  jobStatus         JobStatus?    @map("job_status") // Job assignment status
  assignedBarberId  String?       @map("assigned_barber_id") // Link to Barber when assigned
  declineReason     String?       @db.Text @map("decline_reason") // Reason when declined
  emailSent         Boolean       @default(false) @map("email_sent")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  items             OrderItem[]
  assignedBarber    Barber?       @relation("AssignedOrders", fields: [assignedBarberId], references: [id])

  @@map("orders")
  @@index([orderNumber])
  @@index([customerEmail])
  @@index([paymentReference])
  @@index([status])
  @@index([jobStatus])
  @@index([assignedBarberId])
  @@index([createdAt])
}

model OrderItem {
  id              String   @id @default(uuid())
  orderId         String   @map("order_id")
  productId       String   @map("product_id")
  title           String   // Store product title at time of order
  quantity        Int      @default(1)
  ageGroup        String   // 'adult', 'kids', or 'fixed'
  unitPrice       Decimal  @db.Decimal(10, 2) @map("unit_price")
  totalPrice      Decimal  @db.Decimal(10, 2) @map("total_price")
  createdAt       DateTime @default(now()) @map("created_at")

  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id])

  @@map("order_items")
  @@index([orderId])
  @@index([productId])
}

model CustomerNote {
  id          String   @id @default(uuid())
  customerId  String   @map("customer_id")
  createdBy   String   @map("created_by") // User ID (admin/rep)
  note        String   @db.Text
  isInternal  Boolean  @default(true) @map("is_internal") // Staff-only notes
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_notes")
  @@index([customerId])
  @@index([createdBy])
}

model CustomerTag {
  id         String   @id @default(uuid())
  customerId String   @map("customer_id")
  tag        String
  color      String?  // For UI display
  createdAt  DateTime @default(now()) @map("created_at")
  createdBy  String?  @map("created_by") // User ID (null = auto-generated)

  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_tags")
  @@index([customerId])
  @@index([tag])
  @@unique([customerId, tag])
}

model CustomerAuditLog {
  id          String   @id @default(uuid())
  customerId  String   @map("customer_id")
  action      String   // EDIT, FLAG, BLOCK, UNBLOCK, MERGE, DELETE, RESTORE
  performedBy String   @map("performed_by") // User ID
  reason      String?  @db.Text
  oldValue    Json?    @map("old_value")
  newValue    Json?    @map("new_value")
  metadata    Json?    // Additional context
  createdAt   DateTime @default(now()) @map("created_at")

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_audit_logs")
  @@index([customerId])
  @@index([performedBy])
  @@index([action])
  @@index([createdAt])
}

model CustomerCommunication {
  id            String    @id @default(uuid())
  customerId    String    @map("customer_id")
  type          String    // EMAIL, SMS, PUSH
  channel       String    // BOOKING_REMINDER, PROMOTION, ORDER_CONFIRMATION, etc.
  subject       String?
  message       String?   @db.Text
  status        String    // SENT, DELIVERED, FAILED, BOUNCED
  sentAt        DateTime? @map("sent_at")
  deliveredAt   DateTime? @map("delivered_at")
  campaignId    String?   @map("campaign_id")
  optInStatus   Boolean   @default(true) @map("opt_in_status")
  createdAt     DateTime  @default(now()) @map("created_at")

  customer      Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_communications")
  @@index([customerId])
  @@index([type])
  @@index([channel])
  @@index([sentAt])
}

model CustomerPreference {
  id              String   @id @default(uuid())
  customerId      String   @unique @map("customer_id")
  preferredServices String[] @map("preferred_services")
  preferredBarbers String[] @map("preferred_barbers")
  allergies       String?  @db.Text
  sensitivities   String?  @db.Text
  specialRequests String?  @db.Text @map("special_requests")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_preferences")
}
